
#!/bin/bash

if [ $# -ne 6 ]; then
    echo "Usage : <server-fh-intf> <server-fh-mac> <ru-fh-mac> <delay> <count> <experiment>"
    exit 1
fi
server_fh_intf=$1
server_fh_mac=$2
ru_fh_mac=$3
delay=$4
count=$5
filename=$6

#3.9
payload=aaaaaaaaaa6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f981642a405022040d02f4586e29134f986d6aac09ba64680f851e6814a8d5089369381642a405022040d02f4586e29134f986d8c95e0f96aac09b64680f851e6814a881642a405022040d02f4586e29134f986dd50893681642a405022040d02f4586e29134f986d81642a405022040d02f4586e29134f986d938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96aac09b64680f851e6814a8d508936938c95e0f96adbfcf728303b51b75cd39a0e1a12000b3645c49f9c81b89d8888f8a45db2be84bd4a7dfc2f9c83a2e6303a3cec15f7d88942339d95b1626a4118aa1b8afb118505103efaa9d207fcd07e496058a032ba04841586a58c32810df2562b47f19637342a6e2fbcba9ab9103ddd625a4d37cd9ce2a76cd06753cd13d200bc8952e8b919cfa9533f07d569fc76d5d55d68f5ddaab5d4859cc14c207c6c51c71915afa119dd7afb94682f1bab328b7681daa932e7542b34307c49cc12b01beeb3ba8163aa56658dfb2d29e2ecc4fd9c447416140837e1f9b7e62c274661022a8221e1308095344b0f3d3a49978e220c1bc34d0a31e980313fb398a157b90065a9a33ed5dc528015255274cc664f22cf13cf3d48b0432d3e559d9f4cd259747b06b288d8caa115579114e53946b8729dd9d386c48e8d07413e0f79eb9c8ef965c72edf33b59cba889c6dc316ae06a1885e80f4feaf2ff8dcde742773a1e628035ff6ef422195bfaa873139e3f395617c2df08601a9aa0d63d3f70a618c930c1dd0e672a0748f67d14061ef5b9a697e0ecc1dd18cc13e0abe83c9d5aa4e6e8b5cf7ebc147508f67d14061ef5b9a697e0ecc1dd18cc13e0abe83c9d5aa4e6e8b5cf7ebc147507d14061ef5b9a697e0ecc1dd18cc13e0aaaa47507d14061ef5b9a697e0ecc1dd18cc13e0aaaaecc1dd18cc

echo "Bring up $server_fh_intf"
sudo ip link set $server_fh_intf up

a=0
csv_file="$filename.csv"
echo -n "" > $csv_file
while [ $a -lt $count ]
do
   echo $a
   start_time_ns=$(date +%s%N)
   random_duration=$(awk "BEGIN { srand(); print (0.3 + rand() * (1 - 0.4)) }")
   echo "stressing for : $random_duration"
   set -x
   sudo timeout $random_duration sudo ./execution/tcppump/bin/tcppump -i $server_fh_intf "eth(dmac=$ru_fh_mac, smac=$server_fh_mac, vid=1, ethertype=0x8123, payload=$payload)" -l0 -d $delay -t u
   set +x
   end_time_ns=$(date +%s%N)
   echo "$start_time_ns,$end_time_ns" >> "$csv_file"
   a=`expr $a + 1`
   remaining_time=$(echo "12 - $random_duration" | bc)
   echo "sleeping for : $remaining_time"
   sleep $remaining_time
done
